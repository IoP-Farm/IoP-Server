# Установка и настройка IoP-Farm

## Содержание
1. [Требования](#требования)
2. [Установка оборудования](#установка-оборудования)
3. [Подключение электроники](#подключение-электроники)
4. [Настройка программного обеспечения](#настройка-программного-обеспечения)
5. [Конфигурация системы](#конфигурация-системы)
6. [Запуск и тестирование](#запуск-и-тестирование)
7. [Калибровка датчиков](#калибровка-датчиков)
8. [Обслуживание](#обслуживание)

## Требования

### Аппаратное обеспечение
- Микроконтроллер ESP32
- Датчик температуры DS18B20 (изолированный)
- Ультразвуковой датчик уровня воды HC-SR04
- Датчик влажности почвы FC-28
- Расходомер воды YF-S401
- (Опционально) Датчик влажности воздуха DHT22
- (Опционально) Датчик освещенности KY-018
- Мембранный насос R385
- Драйвер насосов L298N или реле
- Фитолампа (LED-лента 12 В)
- Лампа накаливания для подогрева
- Твердотельное реле (SSR) для управления лампой накаливания
- Модуль реле 5В/12В
- MOSFET-транзисторы (FDN337N)
- DC-DC преобразователь (12V → 5V/3.3V)
- Диоды Шоттки (SS110)
- Блок питания LRS-350-12 (12 В, 29 А)
- Макетная плата
- Провода, коннекторы, корпус

### Программное обеспечение
- Arduino IDE (последняя версия)
- Библиотеки для ESP32
- Библиотеки для работы с датчиками (OneWire, DallasTemperature, DHT и т.д.)
- Библиотека PubSubClient для MQTT
- Драйверы для USB-UART преобразователя

## Установка оборудования

### Механическая сборка

1. **Подготовка корпуса**
   - Установите ESP32 и другие компоненты управления в защищенном корпусе с надлежащей вентиляцией
   - Предусмотрите доступ к USB-порту для программирования

2. **Установка емкости для воды**
   - Установите резервуар для воды в нижней части конструкции
   - Установите датчик уровня воды HC-SR04 в верхней части резервуара
   - Разместите насос R385 с доступом к воде и с безопасным размещением шлангов

3. **Установка системы освещения**
   - Разместите фитолампу (LED-ленту) на верхней части конструкции
   - Обеспечьте равномерное освещение посадочной области
   - Установите систему отражения света для повышения эффективности

4. **Размещение датчиков**
   - Установите датчик температуры DS18B20 в почву и/или воздух (в зависимости от конфигурации)
   - Разместите датчик влажности почвы FC-28 в посадочной области
   - Установите расходомер воды YF-S401 в линию подачи воды
   - (Если используется) установите датчик влажности воздуха DHT22 на уровне растений
   - (Если используется) установите датчик освещенности KY-018 на уровне растений

## Подключение электроники

### Схема подключения

#### Блок питания
1. Подключите блок питания LRS-350-12 к входной сети 220В через подходящий кабель
2. Подключите выход 12В к DC-DC преобразователю и линиям питания исполнительных устройств
3. Подключите DC-DC преобразователь к ESP32 (убедитесь в правильной полярности)

#### Микроконтроллер ESP32
1. GPIO подключения для датчиков:
   - DS18B20: GPIO 4 (требуется подтягивающий резистор 4.7 кОм)
   - HC-SR04: GPIO 12 (Trig), GPIO 14 (Echo)
   - FC-28: GPIO 36 (аналоговый вход)
   - YF-S401: GPIO 5 (импульсный вход)
   - DHT22: GPIO 13
   - KY-018: GPIO 39 (аналоговый вход)

2. GPIO подключения для исполнительных устройств:
   - Насос R385 (через реле): GPIO 25
   - Фитолампа (через MOSFET): GPIO 26 (ШИМ)
   - Лампа накаливания (через SSR): GPIO 27

### Детальное подключение датчиков

#### DS18B20 (датчик температуры)
```
DS18B20 (красный) -> 3.3V ESP32
DS18B20 (желтый/белый) -> GPIO 4 ESP32 -> Резистор 4.7 кОм -> 3.3V ESP32
DS18B20 (черный) -> GND ESP32
```

#### HC-SR04 (ультразвуковой датчик)
```
HC-SR04 VCC -> 5V ESP32
HC-SR04 Trig -> GPIO 12 ESP32
HC-SR04 Echo -> Делитель напряжения (R1=10K, R2=10K) -> GPIO 14 ESP32
HC-SR04 GND -> GND ESP32
```
> Примечание: Делитель напряжения нужен для преобразования 5В сигнала в 3.3В для ESP32

#### FC-28 (датчик влажности почвы)
```
FC-28 VCC -> 3.3V ESP32
FC-28 AOUT -> GPIO 36 ESP32
FC-28 GND -> GND ESP32
```

#### YF-S401 (расходомер воды)
```
YF-S401 VCC (красный) -> 5V ESP32
YF-S401 SIGNAL (желтый) -> GPIO 5 ESP32
YF-S401 GND (черный) -> GND ESP32
```

### Детальное подключение исполнительных устройств

#### Насос R385 (через реле)
```
ESP32 GPIO 25 -> Реле IN
Реле VCC -> 5V питание
Реле GND -> GND питание
Реле NO -> Насос R385 (+)
Насос R385 (-) -> GND питание
```
> Примечание: Добавьте диод SS110 параллельно насосу для защиты от обратного тока

#### Фитолампа LED (через MOSFET)
```
ESP32 GPIO 26 -> MOSFET Gate (резистор 100 Ом)
MOSFET Drain -> LED-лента (-)
LED-лента (+) -> 12V питание
MOSFET Source -> GND питание
```

#### Лампа накаливания (через SSR)
```
ESP32 GPIO 27 -> SSR Input (+)
SSR Input (-) -> GND питание
SSR Output -> Лампа накаливания -> 220V (через соответствующую защиту)
```
> ВАЖНО! Работа с высоким напряжением опасна! Убедитесь, что все соединения изолированы и соблюдаются меры безопасности.

## Настройка программного обеспечения

### Установка Arduino IDE и библиотек

1. Скачайте и установите последнюю версию Arduino IDE с [официального сайта](https://www.arduino.cc/en/software)

2. Настройте поддержку ESP32:
   - Откройте Arduino IDE
   - Перейдите в Файл -> Настройки
   - В поле "Дополнительные URL для менеджера плат" добавьте:
     `https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json`
   - Нажмите OK
   - Перейдите в Инструменты -> Плата -> Менеджер плат
   - Найдите "esp32" и установите последнюю версию

3. Установите необходимые библиотеки:
   - Перейдите в Инструменты -> Управление библиотеками
   - Установите следующие библиотеки:
     - OneWire
     - DallasTemperature
     - DHT sensor library
     - PubSubClient
     - WiFiManager

### Настройка проекта

1. Клонируйте репозиторий проекта:
   ```
   git clone https://github.com/username/IoP-Farm.git
   ```

2. Откройте проект в Arduino IDE или в вашей предпочтительной IDE с поддержкой PlatformIO

3. Настройте конфигурационный файл:
   - Создайте копию файла `include/confidential_example.h` и назовите его `include/confidential.h`
   - Отредактируйте `confidential.h`, добавив ваши данные для Wi-Fi и MQTT:
     ```cpp
     namespace confidential
     {
         constexpr const char* WIFI_SSID     = "your_wifi_ssid";
         constexpr const char* WIFI_PASSWORD = "your_wifi_password";
         constexpr const char* MQTT_SERVER   = "your_mqtt_server";
     }
     ```

4. Убедитесь, что выбрана правильная плата и порт:
   - Инструменты -> Плата -> ESP32 Dev Module
   - Инструменты -> Порт -> (выберите COM-порт, к которому подключен ESP32)

5. Скомпилируйте и загрузите код:
   - Нажмите на кнопку "Загрузка" или Скетч -> Загрузка

## Конфигурация системы

### Настройка параметров выращивания

Настройка параметров осуществляется через веб-интерфейс или MQTT после первого запуска системы. Основные конфигурируемые параметры:

1. **Полив**
   - Частота полива (раз в день/неделю)
   - Длительность полива
   - Минимальная влажность почвы для автоматического включения полива
   - Максимальная влажность почвы для автоматического отключения полива

2. **Освещение**
   - Расписание работы фитолампы (время включения/выключения)
   - Интенсивность освещения (в %)
   - Режим работы (циклический, адаптивный, по расписанию)

3. **Температура**
   - Минимальная допустимая температура
   - Максимальная допустимая температура
   - Гистерезис для избежания частого переключения

4. **Мониторинг**
   - Интервал отправки данных на сервер
   - Параметры оповещений (превышение пороговых значений)

## Запуск и тестирование

### Первый запуск

1. Подключите систему к питанию
2. Подключитесь к Wi-Fi сети, созданной устройством (имя сети: "IoP-Farm-Setup")
3. Откройте браузер и перейдите по адресу 192.168.4.1
4. Настройте подключение к вашей Wi-Fi сети
5. После перезагрузки устройство подключится к указанной сети
6. Откройте последовательный монитор в Arduino IDE (9600 бод) для просмотра отладочной информации

### Тестирование компонентов

#### Тест датчиков

1. В веб-интерфейсе перейдите на страницу "Диагностика"
2. Нажмите "Тест датчиков"
3. Система покажет текущие показания всех датчиков
4. Убедитесь, что все показания находятся в реалистичных пределах:
   - Температура: 10-35°C
   - Влажность почвы: 0-100%
   - Уровень воды: показывает корректное расстояние

#### Тест исполнительных устройств

1. В веб-интерфейсе перейдите на страницу "Диагностика"
2. Нажмите "Тест исполнительных устройств"
3. Проверьте каждое устройство:
   - Насос: включается и выключается по команде
   - Фитолампа: регулируется яркость (0-100%)
   - Нагреватель: включается и выключается по команде

## Калибровка датчиков

### Датчик влажности почвы

1. Поместите датчик в сухую почву
2. Запишите показания (значение для сухой почвы)
3. Поместите датчик в воду
4. Запишите показания (значение для полной влажности)
5. В веб-интерфейсе в настройках введите эти значения для калибровки

### Датчик уровня воды

1. Измерьте реальное расстояние от датчика до поверхности воды
2. Сравните с показаниями в системе
3. При необходимости введите поправочный коэффициент в настройках

### Расходомер воды

1. Наполните мерную емкость через систему полива
2. Сравните показания расходомера с фактическим объемом воды
3. Введите калибровочный коэффициент в настройках

## Обслуживание

### Регулярное обслуживание

#### Еженедельное обслуживание

1. **Резервуар для воды**
   - Проверьте уровень воды
   - Проверьте чистоту воды
   - При необходимости очистите резервуар

2. **Датчики**
   - Проверьте чистоту датчика влажности почвы
   - Убедитесь, что датчик температуры надежно установлен
   - Проверьте, чтобы датчик уровня воды не был заблокирован

3. **Насос и шланги**
   - Проверьте шланги на предмет перегибов и засоров
   - Убедитесь, что насос работает нормально

#### Ежемесячное обслуживание

1. **Электрические соединения**
   - Проверьте все электрические соединения
   - Убедитесь, что нет окисления на контактах

2. **Фитолампа**
   - Очистите поверхность фитолампы от пыли
   - Проверьте интенсивность освещения

3. **Программное обеспечение**
   - Убедитесь, что установлена последняя версия ПО
   - Проверьте журналы на наличие ошибок
   - Сделайте резервную копию конфигурации

### Устранение неисправностей

| Проблема | Возможная причина | Решение |
|----------|-------------------|---------|
| Система не включается | Проблемы с питанием | Проверьте блок питания, кабели и предохранители |
| Нет подключения к Wi-Fi | Неверные настройки или слабый сигнал | Проверьте конфигурацию WiFi, перезагрузите роутер |
| Насос не работает | Засор, неисправность реле | Проверьте шланги, реле, питание насоса |
| Некорректные показания датчиков | Калибровка, загрязнение | Очистите датчики, выполните калибровку |
| Фитолампа не светит | Проблемы с MOSFET, питанием | Проверьте соединения, MOSFET, питание LED-ленты |
| Перегрев системы | Неисправность датчика | Проверьте датчик температуры, систему охлаждения | 